diff --git a/build/single_file_libs/zstd-in.c b/build/single_file_libs/zstd-in.c
index f381ecc4..f53c53e3 100644
--- a/build/single_file_libs/zstd-in.c
+++ b/build/single_file_libs/zstd-in.c
@@ -42,16 +42,41 @@
 #define XXH_PRIVATE_API
 #undef  XXH_INLINE_ALL
 #define XXH_INLINE_ALL
+#define XXH_NO_STDLIB
 #define ZSTD_LEGACY_SUPPORT 0
-#ifndef __EMSCRIPTEN__
-#define ZSTD_MULTITHREAD
-#endif
 #define ZSTD_TRACE 0
 /* TODO: Can't amalgamate ASM function */
 #define ZSTD_DISABLE_ASM 1
 
+#define HUF_FORCE_DECOMPRESS_X1
+#define ZSTD_FORCE_DECOMPRESS_SEQUENCES_SHORT
+#define ZSTD_NO_INLINE
+#define ZSTD_STRIP_ERROR_STRINGS
+#define ZSTD_EXCLUDE_DFAST_BLOCK_COMPRESSOR
+#define ZSTD_EXCLUDE_GREEDY_BLOCK_COMPRESSOR
+#define ZSTD_EXCLUDE_LAZY_BLOCK_COMPRESSOR
+#define ZSTD_EXCLUDE_LAZY2_BLOCK_COMPRESSOR
+#define ZSTD_EXCLUDE_BTLAZY2_BLOCK_COMPRESSOR
+#define ZSTD_EXCLUDE_BTOPT_BLOCK_COMPRESSOR
+
+#define ZSTD_DEPS_COMMON
+#include <limits.h>
+#include <stddef.h>
+
+#define memcpy(d,s,l)  __builtin_memcpy((d),(s),(l))
+#define memmove(d,s,l) __builtin_memmove((d),(s),(l))
+#define memset(p,v,l)  __builtin_memset((p),(v),(l))
+
+#define ZSTD_memcpy(d,s,l)  memcpy((d),(s),(l))
+#define ZSTD_memmove(d,s,l) memmove((d),(s),(l))
+#define ZSTD_memset(p,v,l)  memset((p),(v),(l))
+
+#define ZSTD_DEPS_MALLOC
+#define ZSTD_malloc(s) malloc(s)
+#define ZSTD_calloc(n,s) calloc((n), (s))
+#define ZSTD_free(p) free((p))
+
 /* Include zstd_deps.h first with all the options we need enabled. */
-#define ZSTD_DEPS_NEED_MALLOC
 #define ZSTD_DEPS_NEED_MATH64
 #include "common/zstd_deps.h"
 
@@ -59,7 +84,6 @@
 #include "common/entropy_common.c"
 #include "common/error_private.c"
 #include "common/fse_decompress.c"
-#include "common/threading.c"
 #include "common/pool.c"
 #include "common/zstd_common.c"
 
@@ -84,8 +108,3 @@
 #include "decompress/zstd_ddict.c"
 #include "decompress/zstd_decompress.c"
 #include "decompress/zstd_decompress_block.c"
-
-#include "dictBuilder/cover.c"
-#include "dictBuilder/divsufsort.c"
-#include "dictBuilder/fastcover.c"
-#include "dictBuilder/zdict.c"
diff --git a/lib/common/xxhash.h b/lib/common/xxhash.h
index b6af402f..d07e46cd 100644
--- a/lib/common/xxhash.h
+++ b/lib/common/xxhash.h
@@ -2292,7 +2292,6 @@ XXH3_128bits_reset_withSecretandSeed(XXH_NOESCAPE XXH3_state_t* statePtr,
 /* *************************************
 *  Includes & Memory related functions
 ***************************************/
-#include <string.h>   /* memcmp, memcpy */
 #include <limits.h>   /* ULLONG_MAX */
 
 #if defined(XXH_NO_STREAM)
